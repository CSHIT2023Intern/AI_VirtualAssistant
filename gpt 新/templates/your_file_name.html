<!DOCTYPE html>
<html>
<head>
    <title>OpenAI 語音識別聊天</title>
    <style>
        body {
            background: #f4f4f4;
            font-family: Arial, sans-serif;
        }

        h1 {
            color: #5e2f0d;
            text-align: center;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        button {
            font-size: 14px;
            padding: 8px 12px;
            margin: 0 4px;
            background: #5e2f0d;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #result {
            margin-top: 30px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #5e2f0d;
        }

        #recognizing {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            color: #5e2f0d;
        }

        #api-key-container,
        #loading-indicator {
            margin: 10px auto;
            display: block;
            width: 80%;
            padding: 10px;
            border-radius: 5px;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #api-key-input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 75.5%;
        }

        textarea#prompt {
            height: 100px;
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            resize: none;
        }

        #chat-window {
            height: 300px;
            width: 80%;
            border: 1px solid #ccc;
            overflow-y: scroll;
            margin: 30px auto;
            text-align: left;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .chat-message {
            margin-bottom: 10px;
            color: #5e2f0d;
        }

        .chat-message strong {
            font-weight: bold;
        }

        #loading-indicator {
            display: none;
            margin-top: 10px;
            text-align: center;
        }

        /* Style for the dialog element */
dialog {
    width: 80%; /* Adjust the width as desired */
    max-width: 500px; /* Set a maximum width for the dialog */
    padding: 20px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Style for the close button inside the dialog */
#close-dialog-btn {
    margin-top: 10px;
    padding: 8px 12px;
    background: #5e2f0d;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s ease;
}

#close-dialog-btn:hover {
    background: #92400d;
}

dialog {
    width: 80%; /* Adjust the width as desired */
    max-width: 500px; /* Set a maximum width for the dialog */
    padding: 20px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Style for the close button inside the dialog */
#close-dialog-btn {
    margin-top: 10px;
    padding: 8px 12px;
    background: #5e2f0d;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s ease;
}

#close-dialog-btn:hover {
    background: #92400d;
}

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk/dist/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>

    <audio id="output-audio" controlsstyle="display: none;"></audio>


</head>
<body>
    <h1>OpenAI 語音識別聊天</h1>
<button id="registration-info-btn">掛號資訊</button>

<!-- Dialog element for the popup -->
<dialog id="registration-info-dialog">
    <p>
        您好，若您今天第一次看診，請依照下列步驟：
        在搜尋框輸入"查詢科別名稱"，例如：查詢骨科，骨科要換成您今天要看診的科別。
        <br><br>若您今天有要指定的醫師，那請在搜尋框輸入"查詢科別名稱的醫師"，例如："查詢一般內科的林中生"，
        祝您今天看診愉快!!!
    </p>
    <button id="close-dialog-btn">關閉</button>
</dialog>

   

    <div id="api-key-container">
        <input type="text" id="api-key-input" placeholder="輸入您的 OpenAI API key">
        <button id="api-key-submit">送出</button>
        <button id="api-key-reset">重新輸入金鑰</button>
        
    </div> 
    <div id="loading-indicator">傳輸中請稍候...</div>
    <div id="chat-window">
        <!-- 聊天訊息內容 -->
        <!-- 傳輸中-->
    </div>

    <div class="container">
        <button id="start">開始</button>
        <button id="stop">停止</button>
        <textarea id="prompt" placeholder="在此輸入您的問題"></textarea>
        <button id="submit" disabled>提問</button>
        <button id="clear-input">清除</button>
    </div>

    

    <div id="result"></div>
    <div id="recognizing">辨識中...</div>
    

    <audio id="output-audio" controls style="display: none;"></audio>

<!-- 掛號資訊的開啟 or 關閉 ----------------------------------------------------------------------------------------------->

    <script>
    $(document).ready(function() {
        // Existing code for OpenAI Chat and Speech Recognition ...
    
        $("#registration-info-btn").click(function() {
            // Display the custom dialog
            var dialog = document.getElementById("registration-info-dialog");
            dialog.showModal();
        });
    
        $("#close-dialog-btn").click(function() {
            // Close the custom dialog
            var dialog = document.getElementById("registration-info-dialog");
            dialog.close();
        });
    });
    </script>


<!-- 文本轉語音---------------------------------------------------------------------------------------------------------------------- -->
    <script>
   function playAssistantAudio(event) {
            var audioUrl = event.target.getAttribute("data-audio");
            if (audioUrl) {
                synthesizeTextToSpeech(audioUrl, null); // Use null for voice_name
            }
        }
    // Attach the click event to all speaker icons with the class "speaker-icon"
    $(document).on("click", ".speaker-icon", playAssistantAudio);
    // Add the 'synthesizeTextToSpeech' function here
    function synthesizeTextToSpeech(text, voice_name) {
    var voice_name = "zh-CN-XiaoxiaoNeural";
    $.ajax({
        url:'/synthesize_audio', // 修改为新的路由
        type: 'POST',
        data: { 'text': text, 'voice_name': voice_name },
        success: function(data) {
            if (data.audio_url) {
                var audioPlayer = document.getElementById("output-audio"); // 修改为 output-audio
                audioPlayer.src = data.audio_url;
                audioPlayer.load();
                audioPlayer.play();
                // ... 其他部分不变 ...
            } else {
                console.error('Error: Audio URL not found in the response.');
            }
        },
        error: function() {
            console.error('Error during text-to-speech synthesis.');
        }
    });
}


// Open AI chat---------------------------------------------------------------------------------------------------------------------------
    $(document).ready(function() {
        var openAiApiKey = 'openai_api_key';
        var openAiApiEndpoint = 'openai_api_base/api/ask';
        hideApiKeyInput(); 
        enableChat();


            $("#clear-input").click(function() {
                $("#prompt").val("");
            });

            $("#api-key-submit").click(function() {
                apiKey = $("#api-key-input").val();
                if (apiKey) {
                    if ($("#save-api-key").is(":checked")) {
                        localStorage.setItem('apiKey', apiKey);
                    }
                    hideApiKeyInput();
                    enableChat();
                }
            });
            document.querySelector('#prompt').addEventListener('keydown', function(e) {
            if (e.keyCode === 13) {
            e.preventDefault();
            if (!$("#submit").is(":disabled")) {
            $("#submit").click();
        }
    }
});


            $("#api-key-reset").click(function() {
                localStorage.removeItem('apiKey');
                $("#api-key-input").val("");
                $("#save-api-key").removeAttr("checked");
                showApiKeyInput();
                disableChat();
            });

            $("#submit").click(function() {
    var promptText = $("#prompt").val();
    var voiceName = $("#voice-select").val(); // 獲取所選的語音樣式
    if (apiKey) {
        var chatWindow = $("#chat-window");
        var loadingIndicator = $("#loading-indicator");

        disableChat();
        loadingIndicator.show();

        $.ajax({
            url: '/api/ask',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                "prompt": promptText
            }),
            beforeSend: function(request) {
                request.setRequestHeader("Authorization", apiKey);
            },
            success: function(data) {
                if (data.error && data.error.includes("Invalid API key")) {
                    showError("Invalid API key. Please enter a valid key.");
                    showApiKeyInput();
                    disableChat();
                } else if (data.error) {
                    showError("Error: " + data.error);
                    enableChat();
                } else {
                     // Display the user's prompt in the chat window
                     var chatWindow = $("#chat-window");
                    chatWindow.append("<p class='chat-message'><strong>您:</strong> " + promptText + "</p>");

                   // Display the assistant's reply character by character with typewriter effect
                var assistantReply = data.response;
                var chatWindow = $("#chat-window");
                var chatMessage = $("<p class='chat-message'><strong>助手:</strong> </p>");
                chatWindow.append(chatMessage);

                var i = 0;
                var displayAssistantReply = setInterval(function() {
                    if (i < assistantReply.length) {
                        var partialReply = assistantReply.slice(0, i + 1);
                        chatMessage.text("助手:" + partialReply);
                        chatWindow.scrollTop(chatWindow[0].scrollHeight);
                        i++;
                    } else {
                        clearInterval(displayAssistantReply);
                        // Synthesize assistant's response to speech
                        synthesizeTextToSpeech(assistantReply, voiceName);
                        enableChat();
                    }
                }, 70); // Adjust the delay (in milliseconds) to control the speed of display
                }
            },
            complete: function() {
                loadingIndicator.hide();
            }
        });
    }
});

    // Attach the click event to all speaker icons with the class "speaker-icon"
    $(document).on("click", ".speaker-icon", playAssistantAudio);
            
            function showApiKeyInput() {
                $("#api-key-container").show();
                $("#submit").attr("disabled", true);
            }

            function hideApiKeyInput() {
                $("#api-key-container").hide();
                $("#submit").removeAttr("disabled");
            }

            function enableChat() {
                $("#prompt").removeAttr("disabled");
                $("#submit").removeAttr("disabled");
            }

            function disableChat() {
                $("#prompt").attr("disabled", true);
                $("#submit").attr("disabled", true);
            }

            function showError(message) {
                var chatWindow = $("#chat-window");
                chatWindow.append("<p class='chat-message'><strong>Error:</strong> " + message + "</p>");
                chatWindow.scrollTop(chatWindow[0].scrollHeight);
        }
        });
    </script>


<!-- 語音轉文本--------------------------------------------------------------------------------------------------------------------------- -->
<script>
    var apiKey = 'speech_key';
    var region = 'speech_region';
    var recognizer;

    document.querySelector('#start').onclick = function() {
        startSpeechRecognition();
    };

    document.querySelector('#stop').onclick = function() {
        stopSpeechRecognition();
    };

    function startSpeechRecognition() {
        $('#result').text('處理中...');

        $.ajax({
            url: '/speech-to-text',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(data) {
                var speechToText = data.transcript;
                document.querySelector('#result').innerText = '辨識結果：' + speechToText;
                document.querySelector('#prompt').value = speechToText;

                synthesizeTextToSpeech(speechToText, voiceName);
            },
            error: function() {
                $('#result').text('語音識別期間發生錯誤');
            }
        });
    }

    function stopSpeechRecognition() {
        // ... Your existing code for stopping speech recognition ...
    }

    function synthesizeTextToSpeech(text, voice_name) {
        $.ajax({
            url: '/synthesize_audio',
            type: 'POST',
            data: { 'text': text, 'voice_name': voice_name },
            success: function(data) {
                if (data.audio_url) {
                    var audioPlayer = document.getElementById("output-audio");
                    audioPlayer.src = data.audio_url;
                    audioPlayer.load();
                    audioPlayer.play();
                } else {
                    console.error('Error: Audio URL not found in the response.');
                }
            },
            error: function() {
                console.error('Error during text-to-speech synthesis.');
            }
        });
    }
</script>
</body>
</html>