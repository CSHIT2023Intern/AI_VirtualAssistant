<!DOCTYPE html>
<html>
<head>
    <title>OpenAI 語音識別聊天</title>
    <style>
        body {
            background: #f4f4f4;
            font-family: Arial, sans-serif;
        }

        h1 {
            color: #5e2f0d;
            text-align: center;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        button {
            font-size: 14px;
            padding: 8px 12px;
            margin: 0 4px;
            background: #5e2f0d;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #result {
            margin-top: 30px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #5e2f0d;
        }

        #recognizing {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            color: #5e2f0d;
        }

        #api-key-container,
        #loading-indicator {
            margin: 10px auto;
            display: block;
            width: 80%;
            padding: 10px;
            border-radius: 5px;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #api-key-input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 75.5%;
        }

        textarea#prompt {
            height: 100px;
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            resize: none;
        }
        #conversations {
         width: 100%;
         height: 300px;
         font-size: 18px;
        }

        #chat-window {
            height: 300px;
            width: 80%;
            border: 1px solid #ccc;
            overflow-y: scroll;
            margin: 30px auto;
            text-align: left;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .chat-message {
            margin-bottom: 10px;
            color: #5e2f0d;
        }

        .chat-message strong {
            font-weight: bold;
        }

        #loading-indicator {
            display: none;
            margin-top: 10px;
            text-align: center;
        }

        /* Style for the dialog element */
        dialog {
            width: 80%; /* Adjust the width as desired */
            max-width: 500px; /* Set a maximum width for the dialog */
            padding: 20px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Style for the close button inside the dialog */
        #close-dialog-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #5e2f0d;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        #close-dialog-btn:hover {
            background: #92400d;
        }
        
        #dialog {
            width: 80%; /* Adjust the width as desired */
            max-width: 500px; /* Set a maximum width for the dialog */
            padding: 20px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Style for the close button inside the dialog */
        #close-dialog-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #5e2f0d;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        #close-dialog-btn:hover {
            background: #92400d;
        }
    #registration-info-dialog {
        width: 80%;  /* 對話框的寬度 */
        height: 100%;  /* 對話框的高度 */
        position: fixed;  /* 固定對話框的位置 */
        left: 10%;  /* 對話框距離左邊的距離 */
        top: 10%;  /* 對話框距離頂部的距離 */
        padding: 20px;  /* 對話框內部的填充空間 */
        box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.75);  /* 對話框的陰影 */
        background-color: white;  /* 對話框的背景顏色 */
        border-radius: 10px;  /* 對話框的邊角圓度 */
    }
    .department-btn {
        margin: 10px;  /* 按鈕之間的間距 */
        width: 100px;  /* 按鈕的寬度 */
        height: 60px;  /* 按鈕的高度 */
        font-size: 14px;  /* 按鈕文字的字體大小 */
        background-color: #007BFF;  /* 按鈕的背景顏色 */
        color: white;  /* 按鈕文字的顏色 */
        border: none;  /* 按鈕的邊框 */
        border-radius: 5px;  /* 按鈕的邊角圓度 */
    }
    .department-btn:hover {
        background-color: #0056b3;  /* 滑鼠懸停時的按鈕背景顏色 */
    }
    #close-dialog-btn {
        float: right;  /* 關閉按鈕靠右對齊 */
        margin-top: 10px;  /* 關閉按鈕距離上面的間距 */
    }
</style>

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk/dist/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    
    <audio id="output-audio" controlsstyle="display: none;"></audio>


</head>
<body>
    <h1>OpenAI 語音識別聊天</h1>
    <button id="get-conversations" class="btn btn-primary" data-toggle="modal" data-target="#conversationsModal">查詢對話歷史</button>

    <!-- 對話紀錄模態視窗 -->
    <div class="modal fade" id="conversationsModal" tabindex="-1" role="dialog" aria-labelledby="conversationsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conversationsModalLabel">對話紀錄</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="conversations"></div>
                </div>
                <div class="modal-footer">
                    <nav>
                        <ul class="pagination" id="conversations-pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>



<script>
var pageSize = 5;  // 顯示每頁的對話數量

$("#get-conversations").click(function() {
    $.getJSON("/api/conversations", function(data) {
        var conversations = data.conversations;
        var pageCount = Math.ceil(conversations.length / pageSize);  // 計算總頁數

        $("#conversations").empty();
        $("#conversations-pagination").empty();

        // 為每一頁添加分頁按鈕
        for (var i = 0; i < pageCount; i++) {
            var btn = $('<li class="page-item"><a class="page-link" href="#">' + (i + 1) + '</a></li>');
            $("#conversations-pagination").append(btn);
        }

        // 處理分頁按鈕的點擊事件
        $("#conversations-pagination .page-item").first().addClass('active');
        $("#conversations-pagination .page-link").click(function() {
            var pageIndex = $(this).html() - 1;  // 獲取頁碼
            $("#conversations-pagination .page-item").removeClass('active');
            $(this).parent().addClass('active');

            $("#conversations").empty();
            // 顯示當前頁的對話
            for (var i = pageIndex * pageSize; i < (pageIndex + 1) * pageSize && i < conversations.length; i++) {
                var para = $("<p>" + conversations[i][1] + " : " + conversations[i][2] + "</p>");
                $("#conversations").append(para);
            }
        });

        // 默認顯示第一頁的對話
        for (var i = 0; i < pageSize && i < conversations.length; i++) {
            var para = $("<p>" + conversations[i][1] + " : " + conversations[i][2] + "</p>");
            $("#conversations").append(para);
        }
    });
});
</script>
<button id="registration-info-btn"class="btn btn-primary" data-toggle="modal" data-target="">科別醫師查詢</button>

<!-- Dialog element for the popup -->
<dialog id="registration-info-dialog">
    <p>請選擇要查詢的科別：
<br><br>
<button class="department-btn" data-department="骨科">骨科</button>     
<button class="department-btn" data-department="婦癌科">婦癌科</button>
<button class="department-btn" data-department="感染科">感染科</button>  
<br><br>
<button class="department-btn" data-department="一般內科">一般內科</button>
<button class="department-btn" data-department="內分泌科">內分泌科</button>
<button class="department-btn" data-department="腫瘤內科">腫瘤內科</button>
<button class="department-btn" data-department="腎臟內科">腎臟內科</button>
<button class="department-btn" data-department="一般外科">一般外科</button>
<button class="department-btn" data-department="整形外科">整形外科</button>
<button class="department-btn" data-department="小兒外科">小兒外科</button>
<button class="department-btn" data-department="心臟外科">心臟外科</button>
<button class="department-btn" data-department="神經外科">神經外科</button>
<button class="department-btn" data-department="胸腔外科">胸腔外科</button>
<button class="department-btn" data-department="新生兒科">新生兒科</button>
<br><br>
<button class="department-btn" data-department="肝膽腸胃科">肝膽腸胃科</button>
<button class="department-btn" data-department="血液腫瘤科">血液腫瘤科</button>
<button class="department-btn" data-department="生殖醫學科">生殖醫學科</button>
<button class="department-btn" data-department="海扶刀中心">海扶刀中心</button>
<button class="department-btn" data-department="兒童腎臟科">兒童腎臟科</button>
<button class="department-btn" data-department="兒童神經科">兒童神經科</button>
<button class="department-btn" data-department="兒童腸胃科">兒童腸胃科</button>
<button class="department-btn" data-department="兒童感染科">兒童感染科</button>
<button class="department-btn" data-department="兒童心臟科">兒童心臟科</button>
<button class="department-btn" data-department="兒童急診科">兒童急診科</button>
<br><br>
<button class="department-btn" data-department="肝膽消化外科">肝膽消化外科</button>
<button class="department-btn" data-department="大腸肛門外科">大腸肛門外科</button>
<br><br>
<button class="department-btn" data-department="乳房甲狀腺外科">乳房甲狀腺外科</button>
<button class="department-btn" data-department="過敏免疫風濕科">過敏免疫風濕科</button>
<button class="department-btn" data-department="產科高危險妊娠">產科高危險妊娠</button>
<button class="department-btn" data-department="兒童血液腫瘤科">兒童血液腫瘤科</button>
<br><br>
<button class="department-btn" data-department="心臟內科胸腔內科">心臟內科胸腔內科</button>
<br><br>
<button class="department-btn" data-department="內分泌及遺傳代謝科">內分泌及遺傳代謝科</button>
<button class="department-btn" data-department="兒童過敏免疫風濕科">兒童過敏免疫風濕科</button>
<br><br>
<button class="department-btn" data-department="婦女泌尿暨骨盆重建科">婦女泌尿暨骨盆重建科</button>
<button class="department-btn" data-department="腹腔鏡暨微創手術專科">腹腔鏡暨微創手術專科</button>
        <!-- Add the rest of the department buttons here -->

        <br><br>祝您今天看診愉快!!!
    </p>
    <button id="close-dialog-btn">關閉</button>
</dialog>

   

    <div id="api-key-container">
        <input type="text" id="api-key-input" placeholder="輸入您的 OpenAI API key">
        <button id="api-key-submit">送出</button>
        <button id="api-key-reset">重新輸入金鑰</button>
        
    </div> 
    <div id="loading-indicator">傳輸中請稍候...</div>
    <div id="chat-window">
        <!-- 聊天訊息內容 -->
        <!-- 傳輸中-->
    </div>

    <div class="container">
        <button id="start">開始</button>
        <button id="stop">停止</button>
        <textarea id="prompt" placeholder="在此輸入您的問題"></textarea>
        <button id="submit" disabled>提問</button>
        <button id="clear-input">清除</button>
    </div>

    

    <div id="result"></div>
    <div id="recognizing">辨識中...</div>
    

    <audio id="output-audio" controls style="display: none;"></audio>

<!-- 掛號資訊的開啟 or 關閉 ----------------------------------------------------------------------------------------------->

    <script>
   $(document).ready(function() {
    // Existing code for OpenAI Chat and Speech Recognition ...

    // Function to show the registration department dialog
    $("#registration-info-btn").click(function() {
        var dialog = document.getElementById("registration-info-dialog");
        dialog.showModal();
    });

    // Function to close the registration department dialog
    $("#close-dialog-btn").click(function() {
        var dialog = document.getElementById("registration-info-dialog");
        dialog.close();
    });

    // Function to handle when a department button is clicked
    $(".department-btn").click(function() {
        var department = $(this).data("department");
        var promptText = "查詢" + department;
        $("#prompt").val(promptText); // Set the prompt input with the selected department
        $("#submit").click(); // Trigger the submit button to send the prompt for processing
        var dialog = document.getElementById("registration-info-dialog");
        dialog.close(); // Close the dialog after the department is selected
    });

    // Rest of the existing code for OpenAI Chat and Speech Recognition ...
});
    </script>


<!-- 文本轉語音---------------------------------------------------------------------------------------------------------------------- -->
    <script>
   function playAssistantAudio(event) {
            var audioUrl = event.target.getAttribute("data-audio");
            if (audioUrl) {
                synthesizeTextToSpeech(audioUrl, null); // Use null for voice_name
            }
        }
    // Attach the click event to all speaker icons with the class "speaker-icon"
    $(document).on("click", ".speaker-icon", playAssistantAudio);
    // Add the 'synthesizeTextToSpeech' function here
    function synthesizeTextToSpeech(text, voice_name) {
    var voice_name = "zh-CN-XiaoxiaoNeural";
    $.ajax({
        url:'/synthesize_audio', // 修改为新的路由
        type: 'POST',
        data: { 'text': text, 'voice_name': voice_name },
        success: function(data) {
            if (data.audio_url) {
                var audioPlayer = document.getElementById("output-audio"); // 修改为 output-audio
                audioPlayer.src = data.audio_url;
                audioPlayer.load();
                audioPlayer.play();
                // ... 其他部分不变 ...
            } else {
                console.error('Error: Audio URL not found in the response.');
            }
        },
        error: function() {
            console.error('Error during text-to-speech synthesis.');
        }
    });
}


// Open AI chat---------------------------------------------------------------------------------------------------------------------------
    $(document).ready(function() {
        var openAiApiKey = 'openai_api_key';
        var openAiApiEndpoint = 'openai_api_base/api/ask';
        hideApiKeyInput(); 
        enableChat();


            $("#clear-input").click(function() {
                $("#prompt").val("");
            });

            $("#api-key-submit").click(function() {
                apiKey = $("#api-key-input").val();
                if (apiKey) {
                    if ($("#save-api-key").is(":checked")) {
                        localStorage.setItem('apiKey', apiKey);
                    }
                    hideApiKeyInput();
                    enableChat();
                }
            });
            document.querySelector('#prompt').addEventListener('keydown', function(e) {
            if (e.keyCode === 13) {
            e.preventDefault();
            if (!$("#submit").is(":disabled")) {
            $("#submit").click();
        }
    }
});


            $("#api-key-reset").click(function() {
                localStorage.removeItem('apiKey');
                $("#api-key-input").val("");
                $("#save-api-key").removeAttr("checked");
                showApiKeyInput();
                disableChat();
            });

            $("#submit").click(function() {
    var promptText = $("#prompt").val();
    var voiceName = $("#voice-select").val(); // 獲取所選的語音樣式
    if (apiKey) {
        var chatWindow = $("#chat-window");
        var loadingIndicator = $("#loading-indicator");

        disableChat();
        loadingIndicator.show();

        $.ajax({
            url: '/api/ask',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                "prompt": promptText
            }),
            beforeSend: function(request) {
                request.setRequestHeader("Authorization", apiKey);
            },
            success: function(data) {
                if (data.error && data.error.includes("Invalid API key")) {
                    showError("Invalid API key. Please enter a valid key.");
                    showApiKeyInput();
                    disableChat();
                } else if (data.error) {
                    showError("Error: " + data.error);
                    enableChat();
                } else {
                     // Display the user's prompt in the chat window
                     var chatWindow = $("#chat-window");
                    chatWindow.append("<p class='chat-message'><strong>您:</strong> " + promptText + "</p>");

                   // Display the assistant's reply character by character with typewriter effect
                var assistantReply = data.response;
                var chatWindow = $("#chat-window");
                var chatMessage = $("<p class='chat-message'><strong>助手:</strong> </p>");
                chatWindow.append(chatMessage);

                var i = 0;
                var displayAssistantReply = setInterval(function() {
                    if (i < assistantReply.length) {
                        var partialReply = assistantReply.slice(0, i + 1);
                        chatMessage.text("助手:" + partialReply);
                        chatWindow.scrollTop(chatWindow[0].scrollHeight);
                        i++;
                    } else {
                        clearInterval(displayAssistantReply);
                        // Synthesize assistant's response to speech
                        synthesizeTextToSpeech(assistantReply, voiceName);
                        enableChat();
                    }
                }, 70); // Adjust the delay (in milliseconds) to control the speed of display
                }
            },
            complete: function() {
                loadingIndicator.hide();
            }
        });
    }
});

    // Attach the click event to all speaker icons with the class "speaker-icon"
    $(document).on("click", ".speaker-icon", playAssistantAudio);
            
            function showApiKeyInput() {
                $("#api-key-container").show();
                $("#submit").attr("disabled", true);
            }

            function hideApiKeyInput() {
                $("#api-key-container").hide();
                $("#submit").removeAttr("disabled");
            }

            function enableChat() {
                $("#prompt").removeAttr("disabled");
                $("#submit").removeAttr("disabled");
            }

            function disableChat() {
                $("#prompt").attr("disabled", true);
                $("#submit").attr("disabled", true);
            }

            function showError(message) {
                var chatWindow = $("#chat-window");
                chatWindow.append("<p class='chat-message'><strong>Error:</strong> " + message + "</p>");
                chatWindow.scrollTop(chatWindow[0].scrollHeight);
        }
        });
    </script>


<!-- 語音轉文本--------------------------------------------------------------------------------------------------------------------------- -->
<script>
    var apiKey = 'speech_key';
    var region = 'speech_region';
    var recognizer;

    document.querySelector('#start').onclick = function() {
        startSpeechRecognition();
    };

    document.querySelector('#stop').onclick = function() {
        stopSpeechRecognition();
    };

    function startSpeechRecognition() {
        $('#result').text('處理中...');

        $.ajax({
            url: '/speech-to-text',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(data) {
                var speechToText = data.transcript;
                document.querySelector('#result').innerText = '辨識結果：' + speechToText;
                document.querySelector('#prompt').value = speechToText;

                synthesizeTextToSpeech(speechToText, voiceName);
            },
            error: function() {
                $('#result').text('語音識別期間發生錯誤');
            }
        });
    }

    function stopSpeechRecognition() {
        // ... Your existing code for stopping speech recognition ...
    }

    function synthesizeTextToSpeech(text, voice_name) {
        $.ajax({
            url: '/synthesize_audio',
            type: 'POST',
            data: { 'text': text, 'voice_name': voice_name },
            success: function(data) {
                if (data.audio_url) {
                    var audioPlayer = document.getElementById("output-audio");
                    audioPlayer.src = data.audio_url;
                    audioPlayer.load();
                    audioPlayer.play();
                } else {
                    console.error('Error: Audio URL not found in the response.');
                }
            },
            error: function() {
                console.error('Error during text-to-speech synthesis.');
            }
        });
    }
</script>
</body>
</html>